<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>질문 게시판 - DEEP SKY</title>
    <style>
        /* 1. 공통 스타일 */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Segoe UI", sans-serif; background: #0b0f2b; color: white; line-height: 1.6; }
        
        .hidden { display: none !important; }

        /* 2. 상단 바 */
        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 20px; background: #070a1d; border-bottom: 1px solid #1b2f80; 
            height: 60px; position: sticky; top:0; z-index:1000; 
        }
        .logo-area { display: flex; align-items: center; text-decoration: none; color: white; }
        .logo-area img { width: 35px; height: 35px; margin-right: 10px; border-radius: 50%; }
        .logo-area span { font-size: 18px; font-weight: bold; }
        
        .auth-bar { font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .auth-bar button { padding: 5px 12px; border-radius: 5px; border: none; background: #3a5aff; color: white; cursor: pointer; font-weight: bold; }
        
        /* 3. 내비게이션 */
        header { background: linear-gradient(to right, #0d1b52, #1b2f80); padding: 40px 20px; text-align: center; }
        nav { background: #11153a; padding: 0 10px; text-align: center; border-bottom: 1px solid #2d367a; overflow-x: auto; white-space: nowrap; }
        nav a { display: inline-block; color: white; padding: 15px 20px; text-decoration: none; font-weight: bold; font-size: 15px; }
        nav a:hover { color: #7fc7ff; }
    
        /* 4. 본문 컨테이너 */
        .container { max-width: 900px; margin: 30px auto; padding: 0 20px 100px; }
        
        /* 검색 상자 */
        .search-box { margin-bottom: 20px; }
        .search-box input { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #1b2f80; 
            background: #161b4a; color: white; font-size: 15px; outline: none;
        }
        .search-box input:focus { border-color: #3a5aff; }

        /* 질문 작성 카드 */
        .write-card { background: #161b4a; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #2d367a; }
        .write-card input { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #1b2f80; 
            background: #0b0f2b; color: white; margin-bottom: 10px; outline: none;
        }
        .btn-main { width: 100%; padding: 12px; background: #3a5aff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* 질문 카드 디자인 */
        .q-card { background: #161b4a; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #2d367a; }
        .q-meta { font-size: 12px; color: #7fc7ff; margin-bottom: 8px; }
        .q-text { font-weight: bold; font-size: 16px; margin-bottom: 15px; display: block; border-bottom: 1px solid #2d367a; padding-bottom: 10px; color: #fff; }
        
        /* 답글 영역 */
        .replies-container { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .ans-box { background: rgba(255, 255, 255, 0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #28a745; position: relative; }
        .ans-content { font-size: 14px; color: #eee; line-height: 1.4; padding-right: 30px; }
        .ans-author { font-size: 11px; color: #7fc7ff; margin-top: 5px; display: block; font-weight: bold; }
        .btn-ans-del { position: absolute; top: 10px; right: 10px; background: transparent; color: #ff4d4d; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }

        /* 답글 입력 및 삭제 버튼 */
        .answer-controls { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #2d367a; display: flex; gap: 5px; }
        .answer-controls input { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #1b2f80; background: #0b0f2b; color: white; outline: none; }
        .btn-ans { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-del { background: #ff4d4d; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        footer { background: #070a1d; text-align: center; padding: 30px 20px; font-size: 12px; color: #888; border-top: 1px solid #1b2f80; width: 100%; margin-top: 50px; }

        @media (max-width: 600px) {
            .logo-area span { font-size: 16px; }
            nav a { padding: 12px 10px; font-size: 13px; }
            .answer-controls { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html" class="logo-area">
        <img src="logo.png" onerror="this.src='https://via.placeholder.com/35'">
        <span>DEEP SKY</span>
    </a>
    <div class="auth-bar">
        <span id="userStatus">접속 중...</span>
        <button id="loginBtn" onclick="location.href='login.html'">로그인</button>
        <button id="logoutBtn" class="hidden" onclick="logout()">로그아웃</button>
        <button id="deleteBtn" class="hidden" onclick="deleteAccount()" style="background: #ff4d4d;">회원탈퇴</button>
    </div>
</div>

<header><h1>질문 게시판</h1></header>

<nav>
    <a href="introduce.html">동아리 소개</a>
    <a href="question.html">질문 게시판</a>
    <a href="activity.html">활동 사진</a>
    <a href="resource.html">자료실</a>
    <a href="weather.html">기상 정보</a>
</nav>

<div class="container">
    <div class="search-box">
        <input type="text" id="qSearch" onkeyup="filterQuestions()" placeholder="질문 내용, 작성자, 답글을 검색하세요...">
    </div>

    <div class="write-card">
        <input type="text" id="qInput" placeholder="질문 내용을 입력하세요. (비로그인은 익명 등록)">
        <button class="btn-main" onclick="addQuestion()">질문 등록</button>
    </div>

    <div id="questionList">
        <p style="text-align:center;">데이터를 불러오는 중입니다...</p>
    </div>
</div>

<footer>© DEEP SKY | Bokseong Astronomy and Aerospace Club | All rights reserved.</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// 1. 파이어베이스 설정
const firebaseConfig = {
    apiKey: "AIzaSyArvtIZ3QkwUcvz0SLu-AnLRifhkOtQ9CY",
    authDomain: "bokseong-deep-sky.firebaseapp.com",
    databaseURL: "https://bokseong-deep-sky-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bokseong-deep-sky",
    storageBucket: "bokseong-deep-sky.firebasestorage.app",
    messagingSenderId: "800777151311",
    appId: "1:800777151311:web:8c901fcf0ded04b1941b3a"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const ADMIN_EMAIL = "leader.deepsky@gmail.com";

let currentUser = null;
let currentUserName = "익명";
let cachedData = null; // 실시간 검색을 위한 데이터 캐싱

// 2. 로그인 상태 감지
auth.onAuthStateChanged(user => {
    currentUser = user;
    const status = document.getElementById("userStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    if (user) {
        db.ref('users/' + user.uid + '/name').on('value', (snapshot) => {
            currentUserName = snapshot.val() || user.displayName || user.email.split('@')[0];
            status.innerText = `${currentUserName}님`;
        });
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        deleteBtn.classList.remove("hidden");
    } else {
        currentUserName = "익명";
        status.innerText = "로그인 해주세요";
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        deleteBtn.classList.add("hidden");
    }
    loadQuestions();
});

// 3. 질문 등록
function addQuestion() {
    const text = document.getElementById("qInput").value.trim();
    if(!text) return alert("질문을 입력해주세요.");
    
    db.ref("questions").push({
        text: text,
        author: currentUserName,
        email: currentUser ? currentUser.email : "anonymous",
        createdAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        document.getElementById("qInput").value = "";
    });
}

// 4. 질문 목록 실시간 리스너 및 렌더링
function loadQuestions() {
    db.ref("questions").on("value", snapshot => {
        cachedData = snapshot.val(); // 전체 데이터 캐싱
        renderList(cachedData);
    });
}

function renderList(data) {
    const list = document.getElementById("questionList");
    const searchTerm = document.getElementById("qSearch").value.toLowerCase();
    list.innerHTML = "";

    if(!data) {
        list.innerHTML = "<p style='text-align:center;'>첫 질문을 기다리고 있습니다.</p>";
        return;
    }

    const keys = Object.keys(data).reverse();
    let hasMatch = false;

    keys.forEach(qKey => {
        const q = data[qKey];
        const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;
        const isAuthor = currentUser && currentUser.email === q.email;
        
        // 검색 필터링 (질문 본문, 작성자, 답글 전체 검색)
        const repliesText = q.replies ? Object.values(q.replies).map(r => r.text + r.author).join(" ") : "";
        const searchPool = (q.text + q.author + repliesText).toLowerCase();
        
        if (searchTerm && !searchPool.includes(searchTerm)) return;

        hasMatch = true;
        let repliesHtml = '<div class="replies-container">';
        if (q.replies) {
            Object.keys(q.replies).forEach(rKey => {
                const r = q.replies[rKey];
                const isReplyAuthor = currentUser && currentUser.email === r.email;
                repliesHtml += `
                    <div class="ans-box">
                        <div class="ans-content"><b>A.</b> ${r.text}</div>
                        <span class="ans-author">By ${r.author}</span>
                        ${(isReplyAuthor || isAdmin) ? `<button class="btn-ans-del" onclick="deleteReply('${qKey}', '${rKey}')">삭제</button>` : ""}
                    </div>`;
            });
        }
        repliesHtml += '</div>';

        const card = document.createElement("div");
        card.className = "q-card";
        card.innerHTML = `
            <div class="q-meta">${q.author} | ${new Date(q.createdAt).toLocaleDateString()}</div>
            <span class="q-text">Q. ${q.text}</span>
            ${repliesHtml}
            ${currentUser ? `
            <div class="answer-controls">
                <input type="text" id="ans_${qKey}" placeholder="답글을 남겨주세요...">
                <button class="btn-ans" onclick="saveAnswer('${qKey}')">등록</button>
                ${(isAuthor || isAdmin) ? `<button class="btn-del" onclick="deleteQuestion('${qKey}')">전체삭제</button>` : ""}
            </div>` : ""}
        `;
        list.appendChild(card);
    });

    if (!hasMatch && searchTerm) {
        list.innerHTML = "<p style='text-align:center;'>검색 결과가 없습니다.</p>";
    }
}

// 5. 검색 실행 (입력 시마다 호출)
function filterQuestions() {
    renderList(cachedData);
}

// 6. 답글 저장
function saveAnswer(qKey) {
    const ansText = document.getElementById("ans_"+qKey).value.trim();
    if(!ansText) return alert("내용을 입력하세요.");
    
    db.ref(`questions/${qKey}/replies`).push({
        text: ansText,
        author: currentUserName,
        email: currentUser.email,
        createdAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        document.getElementById("ans_"+qKey).value = "";
    });
}

// 7. 삭제 및 탈퇴 기능
function deleteQuestion(qKey) {
    if(confirm("이 질문과 모든 답글이 삭제됩니다.")) db.ref("questions/"+qKey).remove();
}

function deleteReply(qKey, rKey) {
    if(confirm("이 답글을 삭제하시겠습니까?")) db.ref(`questions/${qKey}/replies/${rKey}`).remove();
}

function logout() {
    if(confirm("로그아웃 하시겠습니까?")) auth.signOut().then(() => location.reload());
}

function deleteAccount() {
    const user = auth.currentUser;
    if (!user) return;
    if (confirm("정말로 탈퇴하시겠습니까? 계정과 개인정보가 즉시 삭제됩니다.")) {
        const uid = user.uid;
        db.ref('users/' + uid).remove()
            .then(() => user.delete())
            .then(() => {
                alert("탈퇴가 완료되었습니다.");
                location.href = "index.html";
            })
            .catch(err => {
                if (err.code === 'auth/requires-recent-login') {
                    alert("보안을 위해 다시 로그인한 직후에만 탈퇴가 가능합니다.");
                } else {
                    alert("오류: " + err.message);
                }
            });
    }
}
</script>
</body>
</html>
