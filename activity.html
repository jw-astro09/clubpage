<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>활동 사진 - DEEP SKY</title>
    <style>
        /* 1. 공통 스타일 및 초기화 */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Segoe UI", AppleSDGothicNeo-Regular, sans-serif; background: #0b0f2b; color: white; line-height: 1.6; }

        /* 2. 상단 바 */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: #070a1d; border-bottom: 1px solid #1b2f80;
            height: 60px; position: sticky; top: 0; z-index: 1000;
        }
        .logo-area { display: flex; align-items: center; text-decoration: none; color: white; }
        .logo-area img { width: 35px; height: 35px; margin-right: 10px; border-radius: 50%; }
        .logo-area span { font-size: 18px; font-weight: bold; letter-spacing: -0.5px; }

        .auth-bar { font-size: 14px; display: flex; align-items: center; gap: 10px; }
        .auth-bar button {
            padding: 5px 12px; border-radius: 5px; border: none;
            background: #3a5aff; color: white; cursor: pointer; font-weight: bold;
        }

        /* 3. 헤더 및 내비게이션 */
        header { background: linear-gradient(to right, #0d1b52, #1b2f80); padding: 38px 20px; text-align: center; }
        nav { background: #11153a; padding: 0 10px; text-align: center; border-bottom: 1px solid #2d367a; overflow-x: auto; white-space: nowrap; }
        nav a { display: inline-block; color: white; padding: 15px 20px; text-decoration: none; font-weight: bold; font-size: 15px; }
        nav a:hover { color: #7fc7ff; }

        /* 4. 본문 컨테이너 및 사진 그리드 */
        .container { max-width: 1100px; margin: 30px auto; padding: 0 20px 100px; }
        
        .upload-card { background: #161b4a; padding: 25px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #2d367a; text-align: center; }
        .upload-card input { 
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; 
            border: 1px solid #1b2f80; background: #0b0f2b; color: white; 
        }
        .btn-upload { width: 100%; padding: 12px; background: #3a5aff; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }
        .photo-card { background: #161b4a; border-radius: 15px; overflow: hidden; border: 1px solid #2d367a; transition: 0.3s; text-align: center; }
        .photo-card:hover { transform: translateY(-5px); border-color: #3a5aff; }
        .photo-card img { width: 100%; height: 200px; object-fit: cover; cursor: pointer; }
        
        .photo-info { padding: 15px; }
        .owner-tag { font-size: 11px; color: #7fc7ff; display: block; margin-bottom: 5px; }
        .photo-title { margin: 5px 0 15px; font-size: 16px; font-weight: bold; }
        
        .btn-group { display: flex; gap: 5px; }
        .btn-group a, .btn-group button { 
            flex: 1; padding: 8px; border-radius: 5px; font-size: 13px; font-weight: bold; 
            text-decoration: none; cursor: pointer; border: none;
        }
        .btn-view { background: #28a745; color: white; }
        .btn-del { background: #ff4d4d; color: white; }

        .hidden { display: none !important; }
        footer { 
            background: #070a1d; text-align: center; padding: 30px 20px;
            font-size: 12px; color: #888; border-top: 1px solid #1b2f80; 
            width: 100%; margin-top: 50px;
        }

        @media (max-width: 600px) {
            .logo-area span { font-size: 16px; }
            nav a { padding: 12px 10px; font-size: 13px; }
            .photo-grid { grid-template-columns: 1fr; }
            header h1 { font-size: 22px; }
        }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html" class="logo-area">
        <img src="logo.png" onerror="this.src='https://via.placeholder.com/35'">
        <span>DEEP SKY</span>
    </a>
    <div class="auth-bar">
        <span id="userStatus">불러오는 중...</span>
        <button id="loginBtn" onclick="location.href='login.html'">로그인</button>
        <button id="logoutBtn" class="hidden" onclick="logout()">로그아웃</button>
        <button id="deleteBtn" class="hidden" onclick="deleteAccount()" style="background: #ff4d4d;">회원탈퇴</button>
    </div>
</div>

<header><h1>활동 사진첩</h1></header>

<nav>
    <a href="introduce.html">동아리 소개</a>
    <a href="question.html">질문 게시판</a>
    <a href="activity.html">활동 사진</a>
    <a href="resource.html">자료실</a>
    <a href="weather.html">기상 정보</a>
</nav>

<div class="container">
    <div id="uploadSection" class="upload-card hidden">
        <h3 style="margin-top:0; color:#7fc7ff;">새 사진 등록</h3>
        <input type="text" id="imageUrl" placeholder="이미지 직접 링크 (https://...jpg)">
        <input type="text" id="imageTitle" placeholder="사진 제목">
        <button class="btn-upload" onclick="uploadPhoto()">갤러리에 올리기</button>
    </div>

    <div class="photo-grid" id="photoGrid">
        <p style="text-align:center; grid-column: 1/-1;">사진을 불러오고 있습니다...</p>
    </div>
</div>

<footer>© DEEP SKY | Bokseong Astronomy and Aerospace Club | All rights reserved.</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyArvtIZ3QkwUcvz0SLu-AnLRifhkOtQ9CY",
    authDomain: "bokseong-deep-sky.firebaseapp.com",
    databaseURL: "https://bokseong-deep-sky-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bokseong-deep-sky",
    storageBucket: "bokseong-deep-sky.firebasestorage.app",
    messagingSenderId: "800777151311",
    appId: "1:800777151311:web:8c901fcf0ded04b1941b3a"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const ADMIN_EMAIL = "leader.deepsky@gmail.com";

let currentUserName = "익명";

// 1. 상태 관리 및 이름 실시간 연동
auth.onAuthStateChanged(user => {
    const status = document.getElementById("userStatus");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const uploadSection = document.getElementById("uploadSection");

    if (user) {
        db.ref('users/' + user.uid + '/name').on('value', (snapshot) => {
            currentUserName = snapshot.val() || user.displayName || user.email.split('@')[0];
            status.innerText = `${currentUserName}님`;
        });
        loginBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
        deleteBtn.classList.remove("hidden");
        uploadSection.classList.remove("hidden");
    } else {
        status.innerText = "로그인 해주세요";
        loginBtn.classList.remove("hidden");
        logoutBtn.classList.add("hidden");
        deleteBtn.classList.add("hidden");
        uploadSection.classList.add("hidden");
    }
    loadPhotos();
});

// 2. 사진 불러오기
function loadPhotos() {
    const grid = document.getElementById("photoGrid");
    db.ref('photos_link').orderByChild('createdAt').on('value', snapshot => {
        grid.innerHTML = "";
        const data = snapshot.val();
        if(!data) {
            grid.innerHTML = "<p style='grid-column:1/-1; text-align:center;'>등록된 사진이 없습니다.</p>";
            return;
        }

        Object.keys(data).reverse().forEach(key => {
            const item = data[key];
            const isAdmin = auth.currentUser && (auth.currentUser.email === ADMIN_EMAIL || auth.currentUser.email === item.ownerEmail);
            
            const card = document.createElement("div");
            card.className = "photo-card";
            card.innerHTML = `
                <img src="${item.url}" onclick="window.open('${item.url}', '_blank')">
                <div class="photo-info">
                    <span class="owner-tag">By ${item.ownerName || '익명'}</span>
                    <div class="photo-title">${item.title}</div>
                    <div class="btn-group">
                        <a href="${item.url}" target="_blank" class="btn-view">원본보기</a>
                        ${isAdmin ? `<button class="btn-del" onclick="deletePhoto('${key}')">삭제</button>` : ''}
                    </div>
                </div>
            `;
            grid.appendChild(card);
        });
    });
}

// 3. 사진 등록
function uploadPhoto() {
    const url = document.getElementById("imageUrl").value.trim();
    const title = document.getElementById("imageTitle").value.trim();
    if(!url || !title) return alert("이미지 링크와 제목을 모두 입력해주세요.");

    db.ref('photos_link').push({
        url: url,
        title: title,
        ownerName: currentUserName,
        ownerEmail: auth.currentUser.email,
        createdAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        alert("사진이 등록되었습니다!");
        document.getElementById("imageUrl").value = "";
        document.getElementById("imageTitle").value = "";
    });
}

// 4. 회원 탈퇴 (관리자 보호 제외)
function deleteAccount() {
    const user = auth.currentUser;
    if (!user) return;

    if (confirm("정말로 탈퇴하시겠습니까? 활동 사진첩에 올린 사진은 유지되지만 계정 정보는 즉시 삭제됩니다.")) {
        const uid = user.uid;
        db.ref('users/' + uid).remove()
            .then(() => {
                return user.delete();
            })
            .then(() => {
                alert("탈퇴가 완료되었습니다.");
                location.href = "index.html";
            })
            .catch(err => {
                if (err.code === 'auth/requires-recent-login') {
                    alert("보안을 위해 다시 로그인한 직후에만 탈퇴가 가능합니다.");
                } else {
                    alert("탈퇴 오류: " + err.message);
                }
            });
    }
}

function deletePhoto(key) { if(confirm("사진을 삭제하시겠습니까?")) db.ref('photos_link/' + key).remove(); }
function logout() { if(confirm("로그아웃 하시겠습니까?")) auth.signOut().then(() => location.reload()); }
</script>
</body>
</html>
