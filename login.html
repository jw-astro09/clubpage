<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인 - DEEP SKY</title>
    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: "Segoe UI", sans-serif; background: #0b0f2b; color: white; min-height: 100vh; display: flex; flex-direction: column; }
        .top-bar { display: flex; align-items: center; padding: 0 20px; background: #070a1d; border-bottom: 1px solid #1b2f80; height: 60px; }
        .logo-area { display: flex; align-items: center; text-decoration: none; color: white; }
        .logo-area img { width: 35px; height: 35px; margin-right: 10px; border-radius: 50%; }
        .logo-area span { font-size: 18px; font-weight: bold; }

        .login-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-box { width: 100%; max-width: 400px; background: #161b4a; padding: 40px 30px; border-radius: 20px; border: 1px solid #2d367a; text-align: center; }
        .login-box h2 { color: #7fc7ff; margin-bottom: 30px; }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 13px; color: #aaa; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #1b2f80; background: #0b0f2b; color: white; outline: none; }
        input:focus { border-color: #3a5aff; }

        .btn-group { margin-top: 25px; display: flex; flex-direction: column; gap: 10px; }
        button { width: 100%; padding: 13px; border-radius: 8px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-login { background: #3a5aff; color: white; }
        .btn-signup { background: transparent; color: #7fc7ff; border: 1px solid #3a5aff; }
        .btn-google { background: white; color: #444; border: 1px solid #ddd; }
        /* GitHub 버튼 스타일 추가 */
        .btn-github { background: #24292e; color: white; }
        .btn-github img { filter: invert(1); } /* GitHub 로고를 흰색으로 */
        
        .link-group { margin-top: 15px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .sub-link { color: #7fc7ff; font-size: 13px; text-decoration: none; cursor: pointer; }
        .sub-link:hover { text-decoration: underline; }
        .info-text { margin-top: 20px; font-size: 12px; color: #666; }

        footer { background: #070a1d; text-align: center; padding: 20px; font-size: 12px; color: #888; border-top: 1px solid #1b2f80; }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html" class="logo-area">
        <img src="logo.png" onerror="this.src='https://via.placeholder.com/35'">
        <span>DEEP SKY</span>
    </a>
</div>

<div class="login-container">
    <div class="login-box">
        <h2>로그인/회원가입</h2>
        
        <div class="input-group">
            <label>이름 (회원가입시)</label>
            <input type="text" id="name" placeholder="실명을 입력해주세요">
        </div>
        <div class="input-group">
            <label>이메일</label>
            <input type="email" id="email" placeholder="example@email.com">
        </div>
        <div class="input-group">
            <label>비밀번호</label>
            <input type="password" id="password" placeholder="6자리 이상">
        </div>

        <div class="btn-group">
            <button class="btn-login" onclick="login()">로그인</button>
            <button class="btn-signup" onclick="signup()">회원가입</button>
            
            <button type="button" class="btn-google" onclick="googleLogin()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Google로 시작하기
            </button>
            
            <button type="button" class="btn-github" onclick="githubLogin()">
                <img src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" width="18"> GitHub로 시작하기
            </button>
        </div>
        
        <div class="link-group">
            <a class="sub-link" onclick="resetPassword()">비밀번호 찾기</a>
            <a class="sub-link" onclick="updateEmail()">이메일 변경</a>
        </div>

        <p class="info-text">
            이메일 인증이 완료되어야 활동이 가능합니다.<br>
            문의: leader.deepsky@gmail.com
        </p>
    </div>
</div>

<footer>© DEEP SKY | Bokseong Astronomy and Aerospace Club</footer>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyArvtIZ3QkwUcvz0SLu-AnLRifhkOtQ9CY",
        authDomain: "bokseong-deep-sky.firebaseapp.com",
        databaseURL: "https://bokseong-deep-sky-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "bokseong-deep-sky",
        storageBucket: "bokseong-deep-sky.firebasestorage.app",
        messagingSenderId: "800777151311",
        appId: "1:800777151311:web:8c901fcf0ded04b1941b3a",
        measurementId: "G-LNZFCW099Z"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    
    // Provider 정의
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    const githubProvider = new firebase.auth.GithubAuthProvider();

    // 1. 구글 로그인 수정
function googleLogin() {
    auth.signInWithPopup(googleProvider)
        .then((result) => {
            const user = result.user;
            
            // [추가] 로그인 성공 시 DB의 users/UID 경로에 정보 저장/업데이트
            db.ref('users/' + user.uid).update({
                name: user.displayName,
                email: user.email,
                lastLogin: new Date().toLocaleString() // 마지막 로그인 시간 기록 (선택사항)
            });

            alert(user.displayName + "님, 환영합니다!");
            location.href = "index.html";
        })
        .catch((error) => handleAuthError(error));
}

// 2. 깃허브 로그인 수정
function githubLogin() {
    auth.signInWithPopup(githubProvider)
        .then((result) => {
            const user = result.user;

            // [추가] 깃허브는 이름(displayName)이 없을 수 있으므로 이메일 앞자리 등으로 대체 로직 추가
            const userName = user.displayName || user.email.split('@')[0] || "회원";

            db.ref('users/' + user.uid).update({
                name: userName,
                email: user.email,
                lastLogin: new Date().toLocaleString()
            });

            alert(userName + "님, 환영합니다! (GitHub)");
            location.href = "index.html";
        })
        .catch((error) => handleAuthError(error));
}

    // 공통 에러 핸들러
    function handleAuthError(error) {
        console.error("Auth Error:", error);
        if (error.code === 'auth/operation-not-allowed') {
            alert("Firebase 콘솔에서 해당 로그인 수단이 활성화되어 있는지 확인하세요.");
        } else if (error.code === 'auth/unauthorized-domain') {
            alert("이 도메인이 Firebase 승인된 도메인에 등록되어 있지 않습니다.");
        } else if (error.code === 'auth/account-exists-with-different-credential') {
            alert("이미 다른 로그인 방식으로 가입된 이메일입니다.");
        } else {
            alert("오류 발생: " + error.message);
        }
    }

    // 3. 이메일 회원가입
    function signup() {
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();
    const pw = document.getElementById("password").value.trim();

    if(!name || !email || !pw) return alert("모든 항목을 입력해주세요.");

    auth.createUserWithEmailAndPassword(email, pw)
        .then(result => {
            const user = result.user;
            // 1. Auth 프로필에 이름 저장 (인증 콘솔용)
            user.updateProfile({ displayName: name });

            // 2. [핵심] Realtime Database에 이름 저장 (관리자 수정용)
            // users/UID/name 경로에 저장합니다.
            db.ref('users/' + user.uid).set({
                name: name,
                email: email
            });

            return user.sendEmailVerification();
        })
        .then(() => {
            alert("가입 성공! 메일함을 확인하여 인증을 완료해주세요.");
            location.href = "index.html";
        })
        .catch(err => alert("가입 실패: " + err.message));
}

    // 4. 이메일 로그인
    function login() {
        const email = document.getElementById("email").value.trim();
        const pw = document.getElementById("password").value.trim();

        if(!email || !pw) return alert("이메일과 비밀번호를 입력해주세요.");

        auth.signInWithEmailAndPassword(email, pw)
            .then(result => {
                if (!result.user.emailVerified) {
                    alert("이메일 인증이 완료되지 않았습니다.");
                    auth.signOut();
                } else {
                    alert("로그인 성공!");
                    location.href = "index.html";
                }
            })
            .catch(err => alert("로그인 실패: " + err.message));
    }

    // 5. 비밀번호 재설정
    function resetPassword() {
        const email = document.getElementById("email").value.trim();
        if (!email) return alert("이메일을 먼저 입력해주세요.");
        auth.sendPasswordResetEmail(email)
            .then(() => alert("비밀번호 재설정 메일을 보냈습니다."))
            .catch(err => alert("에러: " + err.message));
    }

    // 6. 이메일 변경
    function updateEmail() {
        const user = auth.currentUser;
        if (!user) return alert("로그인이 필요합니다.");

        const newEmail = prompt("새로운 이메일 주소:");
        if (newEmail) {
            user.updateEmail(newEmail)
                .then(() => {
                    user.sendEmailVerification();
                    alert("이메일이 변경되었습니다. 다시 인증해주세요.");
                })
                .catch(err => alert("에러: " + err.message));
        }
    }
</script>

</body>
</html>
